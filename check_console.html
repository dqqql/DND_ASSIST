<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ§åˆ¶å°æ£€æŸ¥</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .section { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
    </style>
</head>
<body>
    <h1>ğŸ” æ§åˆ¶å°æ£€æŸ¥å’Œè°ƒè¯•</h1>
    
    <div class="section">
        <h2>é”™è¯¯ä¿¡æ¯è¯´æ˜</h2>
        <div class="warning">
            <strong>âš ï¸ å…³äº "runtime.lastError" é”™è¯¯</strong><br>
            è¿™äº›é”™è¯¯æ˜¯æµè§ˆå™¨æ‰©å±•ç¨‹åºå¼•èµ·çš„ï¼Œä¸æ˜¯æˆ‘ä»¬çš„ä»£ç é—®é¢˜ï¼š<br>
            â€¢ Chromeæ‰©å±•ç¨‹åºå°è¯•ä¸é¡µé¢é€šä¿¡æ—¶äº§ç”Ÿ<br>
            â€¢ ä¸ä¼šå½±å“é¡µé¢çš„æ­£å¸¸åŠŸèƒ½<br>
            â€¢ å¯ä»¥å®‰å…¨å¿½ç•¥è¿™äº›é”™è¯¯<br>
            â€¢ å¦‚æœæƒ³æ¶ˆé™¤ï¼Œå¯ä»¥ç¦ç”¨ç›¸å…³æ‰©å±•ç¨‹åº
        </div>
    </div>

    <div class="section">
        <h2>JavaScript åŠŸèƒ½æµ‹è¯•</h2>
        <button class="btn" onclick="testBasicFunction()">æµ‹è¯•åŸºç¡€åŠŸèƒ½</button>
        <button class="btn" onclick="testDOMAccess()">æµ‹è¯•DOMè®¿é—®</button>
        <button class="btn" onclick="testEventBinding()">æµ‹è¯•äº‹ä»¶ç»‘å®š</button>
        <button class="btn" onclick="testAPICall()">æµ‹è¯•APIè°ƒç”¨</button>
        <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="testLog" class="log">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <div class="section">
        <h2>ä¸»ç•Œé¢å…ƒç´ æ£€æŸ¥</h2>
        <button class="btn" onclick="checkMainPageElements()">æ£€æŸ¥ä¸»ç•Œé¢å…ƒç´ </button>
        <div id="elementLog" class="log">ç‚¹å‡»æŒ‰é’®æ£€æŸ¥å…ƒç´ ...</div>
    </div>

    <div class="section">
        <h2>å®æ—¶é”™è¯¯ç›‘æ§</h2>
        <button class="btn" onclick="startErrorMonitoring()">å¼€å§‹ç›‘æ§</button>
        <button class="btn" onclick="stopErrorMonitoring()">åœæ­¢ç›‘æ§</button>
        <div id="errorLog" class="log">é”™è¯¯ç›‘æ§æœªå¯åŠ¨...</div>
    </div>

    <script>
        let errorMonitoring = false;
        let originalConsoleError = console.error;
        let originalConsoleWarn = console.warn;

        function log(message, type = 'info') {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            
            if (type === 'error') {
                logElement.className = 'log error';
            } else if (type === 'success') {
                logElement.className = 'log success';
            } else {
                logElement.className = 'log';
            }
        }

        function clearLog() {
            document.getElementById('testLog').textContent = '';
            document.getElementById('testLog').className = 'log';
        }

        function testBasicFunction() {
            log('å¼€å§‹æµ‹è¯•åŸºç¡€JavaScriptåŠŸèƒ½...');
            
            try {
                // æµ‹è¯•åŸºæœ¬æ•°æ®ç±»å‹
                const testString = 'Hello World';
                const testNumber = 42;
                const testArray = [1, 2, 3];
                const testObject = { key: 'value' };
                
                log(`âœ… å­—ç¬¦ä¸²: ${testString}`);
                log(`âœ… æ•°å­—: ${testNumber}`);
                log(`âœ… æ•°ç»„: ${JSON.stringify(testArray)}`);
                log(`âœ… å¯¹è±¡: ${JSON.stringify(testObject)}`);
                
                // æµ‹è¯•å‡½æ•°
                const testFunction = () => 'function works';
                log(`âœ… å‡½æ•°: ${testFunction()}`);
                
                // æµ‹è¯•Promise
                Promise.resolve('promise works').then(result => {
                    log(`âœ… Promise: ${result}`);
                });
                
                log('âœ… åŸºç¡€JavaScriptåŠŸèƒ½æµ‹è¯•é€šè¿‡', 'success');
                
            } catch (error) {
                log(`âŒ åŸºç¡€åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testDOMAccess() {
            log('å¼€å§‹æµ‹è¯•DOMè®¿é—®...');
            
            try {
                // æµ‹è¯•åŸºæœ¬DOMæ–¹æ³•
                const body = document.body;
                log(`âœ… document.body: ${body ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                
                const testDiv = document.createElement('div');
                testDiv.id = 'testElement';
                testDiv.textContent = 'Test Element';
                document.body.appendChild(testDiv);
                log('âœ… å…ƒç´ åˆ›å»ºå’Œæ·»åŠ æˆåŠŸ');
                
                const foundElement = document.getElementById('testElement');
                log(`âœ… getElementById: ${foundElement ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
                
                const allDivs = document.querySelectorAll('div');
                log(`âœ… querySelectorAll: æ‰¾åˆ°${allDivs.length}ä¸ªdivå…ƒç´ `);
                
                // æ¸…ç†æµ‹è¯•å…ƒç´ 
                testDiv.remove();
                log('âœ… å…ƒç´ æ¸…ç†å®Œæˆ');
                
                log('âœ… DOMè®¿é—®æµ‹è¯•é€šè¿‡', 'success');
                
            } catch (error) {
                log(`âŒ DOMè®¿é—®æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testEventBinding() {
            log('å¼€å§‹æµ‹è¯•äº‹ä»¶ç»‘å®š...');
            
            try {
                // åˆ›å»ºæµ‹è¯•æŒ‰é’®
                const testButton = document.createElement('button');
                testButton.textContent = 'æµ‹è¯•æŒ‰é’®';
                testButton.id = 'eventTestButton';
                
                let eventTriggered = false;
                
                // ç»‘å®šäº‹ä»¶
                testButton.addEventListener('click', () => {
                    eventTriggered = true;
                    log('âœ… ç‚¹å‡»äº‹ä»¶è§¦å‘æˆåŠŸ');
                });
                
                document.body.appendChild(testButton);
                
                // æ¨¡æ‹Ÿç‚¹å‡»
                testButton.click();
                
                if (eventTriggered) {
                    log('âœ… äº‹ä»¶ç»‘å®šæµ‹è¯•é€šè¿‡', 'success');
                } else {
                    log('âŒ äº‹ä»¶æœªè§¦å‘', 'error');
                }
                
                // æ¸…ç†
                testButton.remove();
                
            } catch (error) {
                log(`âŒ äº‹ä»¶ç»‘å®šæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testAPICall() {
            log('å¼€å§‹æµ‹è¯•APIè°ƒç”¨...');
            
            try {
                // æµ‹è¯•fetchæ˜¯å¦å¯ç”¨
                if (typeof fetch === 'undefined') {
                    log('âŒ fetch APIä¸å¯ç”¨', 'error');
                    return;
                }
                
                log('âœ… fetch APIå¯ç”¨');
                
                // æµ‹è¯•APIè°ƒç”¨
                const response = await fetch('/api/campaigns');
                log(`âœ… APIå“åº”çŠ¶æ€: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… APIæ•°æ®: ${JSON.stringify(data, null, 2)}`);
                    log('âœ… APIè°ƒç”¨æµ‹è¯•é€šè¿‡', 'success');
                } else {
                    log(`âŒ APIå“åº”é”™è¯¯: ${response.status} ${response.statusText}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ APIè°ƒç”¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function checkMainPageElements() {
            const elementLog = document.getElementById('elementLog');
            elementLog.textContent = '';
            
            // æ£€æŸ¥ä¸»ç•Œé¢çš„å…³é”®å…ƒç´ 
            const elementsToCheck = [
                'refreshBtn',
                'helpBtn', 
                'createCampaignBtn',
                'createFirstCampaignBtn',
                'deleteCampaignBtn',
                'webViewBtn',
                'createFileBtn',
                'importFileBtn',
                'showHiddenBtn',
                'editFileBtn',
                'deleteFileBtn',
                'modalClose',
                'modalCancel',
                'modal',
                'campaignList',
                'fileList',
                'viewerContent'
            ];
            
            let foundCount = 0;
            let totalCount = elementsToCheck.length;
            
            elementsToCheck.forEach(id => {
                const element = document.getElementById(id);
                const status = element ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±';
                elementLog.textContent += `${id}: ${status}\n`;
                if (element) foundCount++;
            });
            
            elementLog.textContent += `\næ€»ç»“: ${foundCount}/${totalCount} ä¸ªå…ƒç´ å­˜åœ¨\n`;
            
            if (foundCount === totalCount) {
                elementLog.textContent += 'âœ… æ‰€æœ‰å…ƒç´ éƒ½å­˜åœ¨ï¼ŒDOMç»“æ„æ­£å¸¸\n';
                elementLog.className = 'log success';
            } else {
                elementLog.textContent += 'âš ï¸ éƒ¨åˆ†å…ƒç´ ç¼ºå¤±ï¼Œå¯èƒ½å½±å“åŠŸèƒ½\n';
                elementLog.className = 'log warning';
            }
        }

        function startErrorMonitoring() {
            if (errorMonitoring) return;
            
            errorMonitoring = true;
            const errorLog = document.getElementById('errorLog');
            errorLog.textContent = 'ğŸ” é”™è¯¯ç›‘æ§å·²å¯åŠ¨...\n';
            errorLog.className = 'log';
            
            // ç›‘å¬JavaScripté”™è¯¯
            window.addEventListener('error', function(e) {
                if (e.message.includes('runtime.lastError')) {
                    // å¿½ç•¥æ‰©å±•ç¨‹åºé”™è¯¯
                    return;
                }
                
                const timestamp = new Date().toLocaleTimeString();
                errorLog.textContent += `[${timestamp}] JavaScript Error: ${e.message}\n`;
                errorLog.textContent += `  æ–‡ä»¶: ${e.filename}:${e.lineno}:${e.colno}\n`;
                errorLog.className = 'log error';
                errorLog.scrollTop = errorLog.scrollHeight;
            });
            
            // ç›‘å¬Promise rejection
            window.addEventListener('unhandledrejection', function(e) {
                const timestamp = new Date().toLocaleTimeString();
                errorLog.textContent += `[${timestamp}] Promise Rejection: ${e.reason}\n`;
                errorLog.className = 'log error';
                errorLog.scrollTop = errorLog.scrollHeight;
            });
            
            // é‡å†™console.erroræ¥æ•è·
            console.error = function(...args) {
                const message = args.join(' ');
                if (!message.includes('runtime.lastError')) {
                    const timestamp = new Date().toLocaleTimeString();
                    errorLog.textContent += `[${timestamp}] Console Error: ${message}\n`;
                    errorLog.className = 'log error';
                    errorLog.scrollTop = errorLog.scrollHeight;
                }
                originalConsoleError.apply(console, args);
            };
        }

        function stopErrorMonitoring() {
            errorMonitoring = false;
            console.error = originalConsoleError;
            
            const errorLog = document.getElementById('errorLog');
            errorLog.textContent += '\nğŸ›‘ é”™è¯¯ç›‘æ§å·²åœæ­¢\n';
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
            testBasicFunction();
        });
    </script>
</body>
</html>