# 剧情编辑器架构说明

## 概述

本项目现在提供两种剧情编辑器：

1. **Web 编辑器**（推荐）：现代化的浏览器编辑器，提供更好的用户体验
2. **Legacy 编辑器**：传统的 Tkinter 编辑器，仅用于基础维护和应急修改

## 编辑器对比

| 特性 | Web 编辑器 | Legacy 编辑器 |
|------|------------|---------------|
| 用户界面 | 现代化 Web UI | 传统 Tkinter UI |
| 响应式设计 | ✅ 支持 | ❌ 固定布局 |
| 实时保存 | ✅ 支持 | ❌ 手动保存 |
| 数据验证 | ✅ 实时验证 | ✅ 保存时验证 |
| 快捷键支持 | ✅ 现代快捷键 | ✅ 传统快捷键 |
| 维护状态 | 🚀 持续开发 | ❄️ 冻结维护 |
| 推荐程度 | ⭐⭐⭐⭐⭐ | ⭐⭐ |

## 使用方式

### 1. 通过主应用启动

在主应用中选择 JSON 剧情文件后，会显示两个编辑器选项：
- **🌐 Web 编辑器 (推荐)**：启动现代化的 Web 编辑器
- **📝 Legacy 编辑器**：启动传统的 Tkinter 编辑器

### 2. 独立启动 Web 编辑器

```bash
# 交互式选择跑团
python start_web_editor.py

# 指定跑团
python start_web_editor.py "我的跑团"

# 指定跑团和剧情
python start_web_editor.py "我的跑团" "第一章"
```

### 3. 独立启动 Legacy 编辑器

```bash
python src/story_editor/editor.py
```

## 技术架构

### Web 编辑器架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Web 编辑器前端                           │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│  │   HTML/CSS      │ │   JavaScript    │ │   API Client    │ │
│  │   (editor.html) │ │   (editor.js)   │ │                 │ │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                │ HTTP API
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    Web 服务器层                             │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│  │  HTTP Server    │ │   API Handler   │ │  Static Files   │ │
│  │  (server.py)    │ │ (editor_api.py) │ │                 │ │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                │ Service Calls
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    核心业务层                               │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│  │ Editor Service  │ │ Campaign Service│ │   Data Models   │ │
│  │(story_editor_   │ │ (campaign.py)   │ │   (models.py)   │ │
│  │ service.py)     │ │                 │ │                 │ │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### Legacy 编辑器架构

```
┌─────────────────────────────────────────────────────────────┐
│                  Legacy 编辑器                              │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│  │   Tkinter UI    │ │  Event Handlers │ │  File I/O       │ │
│  │   (editor.py)   │ │                 │ │                 │ │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                │ Direct File Access
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    文件系统                                 │
│                 (JSON 剧情文件)                             │
└─────────────────────────────────────────────────────────────┘
```

## 数据流和兼容性

### 数据格式兼容性

两个编辑器使用完全相同的 JSON 数据格式：

```json
{
  "title": "剧情标题",
  "nodes": [
    {
      "id": "node_01",
      "type": "main",
      "title": "节点标题",
      "content": "节点内容",
      "next": "node_02",
      "branches": [
        {
          "choice": "选择文本",
          "entry": "branch_node_01",
          "exit": "node_03"
        }
      ]
    }
  ]
}
```

### 数据验证

- **Web 编辑器**：通过 `StoryEditorService.validate_story_data()` 进行实时验证
- **Legacy 编辑器**：保存时进行基本格式检查

### 文件操作

- **Web 编辑器**：通过核心服务层进行文件操作，确保数据一致性
- **Legacy 编辑器**：直接操作文件系统，保持向后兼容

## 开发指南

### 添加新功能

1. **Web 编辑器新功能**：
   - 后端：在 `StoryEditorService` 中添加业务逻辑
   - API：在 `EditorAPIHandler` 中添加 HTTP 接口
   - 前端：在 `editor.js` 中添加 UI 逻辑

2. **Legacy 编辑器维护**：
   - 仅进行必要的 bug 修复
   - 不添加新的复杂功能
   - 保持最小维护状态

### 测试

1. **功能测试**：
   - 使用两个编辑器编辑同一个剧情文件
   - 验证数据格式兼容性
   - 测试保存和加载功能

2. **集成测试**：
   - 验证与现有工具链的兼容性
   - 测试 DOT/SVG 生成功能
   - 确保预览功能正常

## 迁移建议

### 用户迁移

1. **新用户**：直接使用 Web 编辑器
2. **现有用户**：
   - 逐步迁移到 Web 编辑器
   - Legacy 编辑器作为备用方案
   - 数据完全兼容，无需转换

### 开发迁移

1. **新功能开发**：优先在 Web 编辑器中实现
2. **Bug 修复**：
   - Web 编辑器：正常修复和优化
   - Legacy 编辑器：仅修复严重问题

## 未来规划

### 短期目标（1-3个月）

- [ ] 完善 Web 编辑器的用户体验
- [ ] 添加更多快捷键支持
- [ ] 优化移动端适配
- [ ] 添加撤销/重做功能

### 中期目标（3-6个月）

- [ ] 添加协作编辑功能
- [ ] 集成剧情图实时预览
- [ ] 添加模板和代码片段
- [ ] 支持插件扩展

### 长期目标（6个月以上）

- [ ] 完全替代 Legacy 编辑器
- [ ] 支持云端同步
- [ ] 添加版本控制功能
- [ ] 多语言支持

## 注意事项

1. **数据安全**：两个编辑器都会在保存前创建备份文件
2. **性能考虑**：Web 编辑器适合中小型剧情，大型剧情可能需要优化
3. **浏览器兼容性**：Web 编辑器支持现代浏览器（Chrome、Firefox、Safari、Edge）
4. **网络要求**：Web 编辑器使用本地服务器，无需互联网连接

## 故障排除

### Web 编辑器无法启动

1. 检查端口是否被占用
2. 确认浏览器支持 JavaScript
3. 查看控制台错误信息

### Legacy 编辑器问题

1. 确认 Python 环境正确
2. 检查 Tkinter 库是否安装
3. 验证文件权限

### 数据兼容性问题

1. 使用数据验证 API 检查文件格式
2. 查看错误日志获取详细信息
3. 使用备份文件恢复数据