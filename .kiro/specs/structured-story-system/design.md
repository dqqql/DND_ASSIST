# 结构化分支剧情系统设计文档

## 概述

在现有DND跑团管理器的notes分类中添加JSON格式的结构化剧情文件支持。通过最小化修改现有代码，实现主线剧情+分支选择的结构化展示。

## 架构

### 核心组件

1. **文件创建扩展**: 修改`create_file()`方法，支持创建.json剧情文件
2. **JSON剧情查看器**: 新增`show_json_story_content()`方法，解析并展示JSON剧情结构
3. **剧情模板**: 提供基础的JSON模板结构

### 集成点

- 在现有的`on_file_select()`中添加.json文件处理逻辑
- 在现有的`create_file()`中添加文件类型选择
- 重用现有的文件读取和错误处理机制

## 数据模型

### JSON剧情文件结构

```json
{
  "title": "剧情标题",
  "nodes": [
    {
      "id": "main_01",
      "type": "main",
      "title": "节点标题",
      "content": "节点内容描述",
      "next": "main_02",
      "branches": [
        {
          "choice": "选择描述",
          "entry": "branch_A_01",
          "exit": "main_02"
        }
      ]
    },
    {
      "id": "branch_A_01",
      "type": "branch",
      "title": "分支标题",
      "content": "分支内容",
      "next": "branch_A_02"
    }
  ]
}
```

### 字段说明

- `title`: 剧情总标题
- `nodes`: 所有剧情节点数组
- `id`: 节点唯一标识符
- `type`: 节点类型（"main"主线，"branch"分支）
- `title`: 节点标题
- `content`: 节点内容描述
- `next`: 下一个节点ID（可为null表示结束）
- `branches`: 分支选择数组（仅主线节点有）
- `choice`: 选择项描述文本
- `entry`: 分支入口节点ID
- `exit`: 分支出口节点ID（回到主线的位置）

## 组件和接口

### 文件创建修改

修改`create_file()`方法：
- 当分类为"notes"时，弹出文件类型选择对话框
- 选择"结构化剧情"创建.json文件，选择"普通剧情"创建.txt文件
- 为.json文件提供基础模板内容

### JSON剧情查看器

新增`show_json_story_content(file_path)`方法：
- 解析JSON文件内容
- 构建可展开的树形结构显示
- 使用Tkinter的Text控件和标签系统实现展开/折叠
- 错误处理：JSON格式错误时显示友好提示

### 显示逻辑

在`on_file_select()`中添加：
```python
elif filename.endswith('.json') and self.current_category == "notes":
    self.show_json_story_content(file_path)
```

## 用户界面设计

### 文件创建对话框

当在notes分类点击"新建文件"时：
1. 弹出文件类型选择对话框
2. 提供两个选项：
   - "普通剧情 (.txt)"
   - "结构化剧情 (.json)"
3. 根据选择创建对应类型的文件

### JSON剧情显示格式

在右侧内容区域以文本形式展示：
```
📖 剧情标题

🎯 主线: 进入废弃城堡
   你们站在城堡门前，夜色笼罩着破败的城墙。
   
   🔀 选择分支:
   ├─ 从正门进入 → [分支A] → 回到: 探索城堡内部
   └─ 绕到后门潜入 → [分支B] → 回到: 探索城堡内部

🎯 主线: 探索城堡内部
   你们成功进入了城堡...

📝 分支A: 正门遭遇守卫
   你们推开正门，惊动了潜伏的守卫。
   
   📝 分支A: 击败守卫
   守卫被击败，你们得以继续前进。
```

### 展开/折叠功能

- 使用简单的文本标记实现
- 点击主线节点可展开/折叠其分支详情
- 默认显示主线概览，分支详情可选展开

## 错误处理

### JSON解析错误
- 捕获JSON格式错误
- 在内容区域显示："JSON格式错误: [具体错误信息]"
- 提供编辑建议

### 文件读取错误
- 重用现有的文件读取错误处理机制
- 在内容区域显示错误信息

## 测试策略

### 单元测试
- 测试JSON解析功能
- 测试文件创建功能
- 测试错误处理

### 集成测试
- 测试与现有文件管理的集成
- 测试.txt和.json文件混合使用
- 测试UI交互流程

## 正确性属性

*属性是一个特征或行为，应该在系统的所有有效执行中保持为真——本质上是关于系统应该做什么的正式声明。属性作为人类可读规范和机器可验证正确性保证之间的桥梁。*

### Property 1: JSON模板结构完整性
*对于任何*新创建的.json剧情文件，文件内容应该包含有效的JSON结构，包含title字段和至少一个主线节点示例
**验证需求: Requirements 1.2**

### Property 2: JSON解析一致性
*对于任何*有效的JSON剧情文件，解析后的数据结构应该能够正确识别所有主线节点和分支节点
**验证需求: Requirements 1.3, 2.1**

### Property 3: 显示格式正确性
*对于任何*包含主线和分支的JSON剧情文件，显示的文本应该包含正确的格式标记（🎯主线、📝分支、🔀选择分支）
**验证需求: Requirements 2.2**

### Property 4: 错误处理鲁棒性
*对于任何*格式错误的JSON文件，系统应该显示包含"JSON格式错误"的错误信息而不是崩溃
**验证需求: Requirements 2.3**

### Property 5: 文件重新加载一致性
*对于任何*被外部修改的.json文件，重新选择该文件后显示的内容应该反映最新的文件内容
**验证需求: Requirements 3.2**

### Property 6: 向后兼容性保持
*对于任何*现有的.txt剧情文件，新系统应该保持与原系统完全相同的显示和编辑行为
**验证需求: Requirements 4.1, 4.2**

## 错误处理

### JSON解析错误
- 捕获JSON格式错误
- 在内容区域显示："JSON格式错误: [具体错误信息]"
- 提供编辑建议

### 文件读取错误
- 重用现有的文件读取错误处理机制
- 在内容区域显示错误信息

## 测试策略

### 单元测试和属性测试的双重方法
- **单元测试**: 验证特定示例、边界情况和错误条件
- **属性测试**: 验证所有输入的通用属性
- 两者互补，提供全面覆盖

### 单元测试重点
- 特定的JSON结构示例
- 文件创建和编辑的集成点
- 边界情况和错误条件

### 属性测试重点
- JSON解析的通用正确性
- 显示格式的一致性
- 向后兼容性验证

### 属性测试配置
- 每个属性测试最少100次迭代
- 每个测试引用其设计文档属性
- 标签格式: **Feature: structured-story-system, Property {number}: {property_text}**