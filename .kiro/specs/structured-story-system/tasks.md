# 实现计划: 结构化分支剧情系统

## 概述

通过最小化修改现有main.py文件，添加JSON格式剧情文件的创建、解析和显示功能。重用现有的UI组件和文件处理机制。

## 任务

- [x] 1. 修改文件创建逻辑支持JSON剧情文件
  - 修改`create_file()`方法，在notes分类时提供文件类型选择
  - 创建JSON剧情文件模板生成功能
  - _需求: 1.1, 1.2_

- [ ]* 1.1 为文件创建功能编写单元测试
  - 测试文件类型选择对话框
  - 测试JSON模板生成
  - _需求: 1.1, 1.2_

- [x] 2. 实现JSON剧情内容解析和显示
  - [x] 2.1 创建`show_json_story_content()`方法
    - 解析JSON文件内容
    - 构建结构化文本显示
    - _需求: 2.1, 2.2_

  - [ ]* 2.2 编写JSON解析属性测试
    - **Property 2: JSON解析一致性**
    - **验证需求: Requirements 1.3, 2.1**

  - [x] 2.3 添加JSON格式错误处理
    - 捕获JSON解析异常
    - 显示友好的错误信息
    - _需求: 2.3_

  - [ ]* 2.4 编写错误处理属性测试
    - **Property 4: 错误处理鲁棒性**
    - **验证需求: Requirements 2.3**

- [x] 3. 集成JSON文件支持到现有文件选择逻辑
  - 修改`on_file_select()`方法，添加.json文件处理
  - 确保与现有.txt文件功能完全兼容
  - _需求: 3.2, 4.1, 4.2_

- [ ]* 3.1 编写向后兼容性属性测试
  - **Property 6: 向后兼容性保持**
  - **验证需求: Requirements 4.1, 4.2**

- [ ] 4. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 5. 完善显示格式和用户体验
  - [x] 5.1 优化JSON剧情的显示格式
    - 实现emoji图标和缩进格式
    - 添加分支结构的清晰展示
    - _需求: 2.2_

  - [ ]* 5.2 编写显示格式属性测试
    - **Property 3: 显示格式正确性**
    - **验证需求: Requirements 2.2**

  - [x] 5.3 测试文件重新加载功能
    - 验证外部编辑后的内容更新
    - _需求: 3.2_

  - [ ]* 5.4 编写文件重新加载属性测试
    - **Property 5: 文件重新加载一致性**
    - **验证需求: Requirements 3.2**

- [x] 6. 最终检查点 - 完整功能验证
  - 确保所有功能正常工作，如有问题请询问用户

## 注意事项

- 标记为`*`的任务为可选测试任务，专注于核心功能实现
- 每个任务都引用了具体的需求编号以确保可追溯性
- 使用检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况